/*
WARNING: Recursive script decompilation (for member variable name resolution) failed for gml_Script_game_in_focus

System.InvalidOperationException: Stack empty.
   at System.Collections.Generic.Stack`1.ThrowForEmptyStack()
   at System.Collections.Generic.Stack`1.Pop()
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block, List`1 tempvars, Stack`1 workQueue) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 280
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 795
   at UndertaleModLib.Decompiler.Decompiler.<DecompileFromBlock>g__FindActualNameForAnonymousCodeObject|3_2(DecompileContext context, UndertaleCode anonymousCodeObject) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 563
*/
/*
WARNING: Recursive script decompilation (for asset type resolution) failed for gml_Script_game_in_focus

System.InvalidOperationException: Stack empty.
   at System.Collections.Generic.Stack`1.ThrowForEmptyStack()
   at System.Collections.Generic.Stack`1.Pop()
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block, List`1 tempvars, Stack`1 workQueue) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 280
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 795
   at UndertaleModLib.Decompiler.Decompiler.DirectFunctionCall.DoTypePropagation(DecompileContext context, AssetIDType suggestedType) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Instructions\Decompiler.DirectFunctionCall.cs:line 139
*/
/*
WARNING: Recursive script decompilation (for member variable name resolution) failed for gml_Script_uiCatspeakGetEnvironment

System.InvalidOperationException: Stack empty.
   at System.Collections.Generic.Stack`1.ThrowForEmptyStack()
   at System.Collections.Generic.Stack`1.Pop()
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block, List`1 tempvars, Stack`1 workQueue) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 280
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 795
   at UndertaleModLib.Decompiler.Decompiler.<DecompileFromBlock>g__FindActualNameForAnonymousCodeObject|3_2(DecompileContext context, UndertaleCode anonymousCodeObject) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 563
*/
/*
WARNING: Recursive script decompilation (for asset type resolution) failed for gml_Script_uiCatspeakGetEnvironment

System.InvalidOperationException: Stack empty.
   at System.Collections.Generic.Stack`1.ThrowForEmptyStack()
   at System.Collections.Generic.Stack`1.Pop()
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block, List`1 tempvars, Stack`1 workQueue) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 280
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 795
   at UndertaleModLib.Decompiler.Decompiler.DirectFunctionCall.DoTypePropagation(DecompileContext context, AssetIDType suggestedType) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Instructions\Decompiler.DirectFunctionCall.cs:line 139
*/
/*
WARNING: Recursive script decompilation (for member variable name resolution) failed for gml_Script_uiDebugRelaxedSprites

System.InvalidOperationException: Stack empty.
   at System.Collections.Generic.Stack`1.ThrowForEmptyStack()
   at System.Collections.Generic.Stack`1.Pop()
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block, List`1 tempvars, Stack`1 workQueue) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 280
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 795
   at UndertaleModLib.Decompiler.Decompiler.<DecompileFromBlock>g__FindActualNameForAnonymousCodeObject|3_2(DecompileContext context, UndertaleCode anonymousCodeObject) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 563
*/
/*
WARNING: Recursive script decompilation (for asset type resolution) failed for gml_Script_uiDebugRelaxedSprites

System.InvalidOperationException: Stack empty.
   at System.Collections.Generic.Stack`1.ThrowForEmptyStack()
   at System.Collections.Generic.Stack`1.Pop()
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block, List`1 tempvars, Stack`1 workQueue) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 280
   at UndertaleModLib.Decompiler.Decompiler.DecompileFromBlock(DecompileContext context, Dictionary`2 blocks, Block block) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Decompiler.cs:line 795
   at UndertaleModLib.Decompiler.Decompiler.DirectFunctionCall.DoTypePropagation(DecompileContext context, AssetIDType suggestedType) in D:\a\UndertaleModTool\UndertaleModTool\UndertaleModLib\Decompiler\Instructions\Decompiler.DirectFunctionCall.cs:line 139
*/
if (phase_delay > 0)
    phase_delay--
else
{
    switch phase
    {
        case 0:
            if (!steam_initialised())
                trace("Init: Running in offline mode")
            else
                trace("Init: Running in online mode, account ID = ", steam_get_user_account_id())
            phase++
            break
        case 1:
            ui_initialize_debug_behaviours()
            ui_initialize_functions()
            ui_initialize_constants_and_assets()
            ui_initialize_data_struct()
            phase++
            break
        case 2:
            trace("Init: Setting up databases")
            scr_setup_save_databases()
            phase++
            break
        case 3:
            trace("Init: Loading settings")
            db_load("local settings")
            db_load("shared settings")
            phase++
            break
        case 4:
            global.database_was_previously_using_cloud_saves = db_read_ext("local settings", "cloud", "using_cloud", undefined)
            db_cloud_sync_all()
            phase++
            break
        case 5:
            trace("Init: Applying settings")
            settings_reload_and_apply()
            if settings_get("fullscreen")
                phase_delay = 20
            phase++
            break
        case 6:
            trace("Init: Loading video")
            video = video_open("ZS_boot.mp4")
            var _video_duration = video_get_duration()
            alarm[0] = (floor(_video_duration / 1000 * 60)) + 60
            video_enable_loop(false)
            phase++
            break
        case 7:
            if db_read_ext("shared settings", "Game analytics", "collect_data", false)
            {
                trace("Init: Setting up analytics")
                scr_ga_setup()
            }
            phase++
            break
        case 8:
            difficulty_reset_all("rookie")
            phase++
            break
        case 9:
            trace("Init: Loading game data from JSON")
            gamedata_initialize_and_load()
            phase++
            break
        case 10:
            trace("Init: Loading templates")
            building_index_load("template_index.json")
            phase++
            break
        case 11:
            trace("Init: Done!")
            var _i = 0
            repeat parameter_count()
            {
                if (parameter_string(_i) == "-strict_cloud")
                    global.strict_steam_mode = true
                _i++
            }
            var _report_string = ""
            if global.trace_to_file
                _report_string += "\"Log To File\" mode enabled\n"
            if global.strict_steam_mode
                _report_string += "\"Strict Cloud\" mode enabled\n"
            if (_report_string != "")
                show_message(_report_string)
            if global.strict_steam_mode
            {
                if (!steam_initialised())
                    trace_error("Steam initialization failed")
            }
            phase++
            break
        case 12:
            if (!instance_exists(obj_gamepad))
                instance_create_depth(-1, -1, -10000, obj_gamepad)
            if (!instance_exists(obj_cursor))
                instance_create_depth(-1, -1, -10000, obj_cursor)
            if (!instance_exists(obj_buffer_async))
                instance_create_depth(-1, -1, -10000, obj_buffer_async)
            phase++
            break
        case 13:
            if (db_read_ext("local settings", "first_time", "first_time", false) || show_prompt)
            {
                if (gml_Script_game_in_focus() && (keyboard_check_released(vk_anykey) || mouse_check_button_released(mb_any) || obj_gamepad.input_released[(29 << 0)]))
                {
                    video_close()
                    show_prompt = false
                    phase++
                }
            }
            break
        case 14:
            if (prompt_alpha <= 0)
            {
                db_open("local settings")
                db_write("first_time", "first_time", true)
                db_close()
                room_goto(r_menu)
            }
            break
    }

}
